import{e9 as O,K as w,ea as v,eb as N}from"./main-CA1CST7A.js";import{P as R,$ as x}from"./utils-CgWSY1AP.js";import{n as G,l as J}from"./fetchService-CvMF-9I3.js";import{o as _}from"./jsonContext-CeDsIVV-.js";import{l as D,u,c as Y,E as c}from"./portalItemUtils-DgqLSRlg.js";const p="Feature Service",d="feature-layer-utils",C=`${d}-save`,$=`${d}-save-as`;function m(e){return{isValid:O(e)&&(!("dynamicDataSource"in e)||!e.dynamicDataSource),errorMessage:"Feature layer should be a layer or table in a map or feature service"}}function h(e,r){const a=_(e,"portal-item");return r?.isTable&&(a.layerContainerType="tables"),a}function b(e){const r=[],a=[];for(const{layer:t,layerJSON:o}of e)F(t)?a.push(o):r.push(o);return{layers:r,tables:a}}function F(e,r){return e.isTable}function T(e){return b([e])}async function K(e,r){return/\/\d+\/?$/.test(e.url)?T(r[0]):M(r,e)}async function M(e,r){if(e.reverse(),!r)return b(e);const a=await U(r,e);for(const t of e)E(t.layer,t.layerJSON,a);return j(a,e),a}async function U(e,r){let a=await e.fetchData("json");if(k(a))return a;a||={},B(a);const{layer:{url:t,customParameters:o,apiKey:n}}=r[0];return await H(a,{url:t??"",customParameters:o,apiKey:n},r.map(s=>s.layer.layerId)),a}function k(e){return!!(e&&Array.isArray(e.layers)&&Array.isArray(e.tables))}function B(e){e.layers||=[],e.tables||=[]}function j(e,r){const a=[],t=[];for(const{layer:o}of r){const{isTable:n,layerId:s}=o;n?t.push(s):a.push(s)}L(e.layers,a),L(e.tables,t)}function L(e,r){if(e.length<2)return;const a=[];for(const{id:t}of e)a.push(t);v(a.sort(S),r.slice().sort(S))&&e.sort((t,o)=>{const n=r.indexOf(t.id),s=r.indexOf(o.id);return n<s?-1:n>s?1:0})}function S(e,r){return e<r?-1:e>r?1:0}async function H(e,r,a){const{url:t,customParameters:o,apiKey:n}=r,{serviceJSON:s,layersJSON:i}=await G(t,{customParameters:o,apiKey:n}),l=I(e.layers,s.layers,a),y=I(e.tables,s.tables,a);e.layers=l.itemResources,e.tables=y.itemResources;const f=[...l.added,...y.added],P=i?[...i.layers,...i.tables]:[];await V(e,f,t,P)}function I(e,r,a){const t=N(e,r,(n,s)=>n.id===s.id);e=e.filter(n=>!t.removed.some(s=>s.id===n.id));const o=t.added;return o.forEach(({id:n})=>{e.push({id:n})}),{itemResources:e,added:o.filter(({id:n})=>!a.includes(n))}}async function V(e,r,a,t){const o=await q(r),n=r.map(({id:s,type:i})=>new(o.get(i))({url:a,layerId:s,sourceJSON:t.find(({id:l})=>l===s)}));await Promise.allSettled(n.map(s=>s.load())),n.forEach(s=>{const{layerId:i,loaded:l,defaultPopupTemplate:y}=s;if(!l||y==null)return;const f={id:i,popupInfo:y.toJSON()};E(s,s.operationalLayerType==="ArcGISFeatureLayer"?f:{...f,layerType:s.operationalLayerType},e)})}async function q(e){const r=[];e.forEach(({type:o})=>{switch(J(o)){case"CatalogLayer":r.push(import("./CatalogLayer-B0bZFP0t.js").then(n=>n.default));break;case"FeatureLayer":r.push(import("./FeatureLayer-mcGhpTTB.js").then(n=>n.default));break;case"OrientedImageryLayer":r.push(import("./OrientedImageryLayer-8vvcRmji.js").then(n=>n.default))}});const a=await Promise.all(r),t=new Map;return e.forEach(({type:o},n)=>{t.set(o,a[n])}),t}function E(e,r,a){e.isTable?g(a.tables,r):g(a.layers,r)}function g(e,r){const a=e.findIndex(({id:t})=>t===r.id);a===-1?e.push(r):e[a]=r}function z(e){if(!("layerType"in e))return!!e.charts?.length;switch(e.layerType){case"OrientedImageryLayer":return!!e.charts?.length;case"SubtypeGroupLayer":return!!e.layers.some(r=>!!r.charts?.length);case"SubtypeGroupTable":return!!e.tables.some(r=>!!r.charts?.length);case"CatalogLayer":return!!e.footprintLayer?.charts?.length}}function A(e,r){let a=0,t=0,o=0,n=0;for(const s of[...r.layers,...r.tables])if(z(s)&&n++,"layerType"in s)switch(s.layerType){case"OrientedImageryLayer":a++;break;case"SubtypeGroupLayer":t++;break;case"SubtypeGroupTable":o++}u(e,c.ORIENTED_IMAGERY_LAYER,a>0),u(e,c.SUBTYPE_GROUP_LAYER,t>0),u(e,c.SUBTYPE_GROUP_TABLE,o>0),u(e,c.CHARTS,n>0)}function Q(e,r,a){Y(r,c.METADATA),u(r,c.MULTI_LAYER,e.length>1),u(r,c.SINGLE_LAYER,e.length===1),u(r,c.TABLE,a.tables.length>0&&a.layers.length===0),A(r,a)}async function W(e,r,a){A(r,a)}async function Z(e,r,a){const{url:t,layerId:o,title:n,fullExtent:s,isTable:i}=e,l=w(t);r.url=(l?.serverType==="FeatureServer"?t:`${t}/${o}`)??null,r.title||=n,r.extent=null,i||s==null||(r.extent=await D(s)),Q([e],r,a)}async function X(e,r){return R({layer:e,itemType:p,validateLayer:m,createJSONContext:a=>h(a,e),createItemData:(a,t)=>K(t,[a]),errorNamePrefix:C,setItemProperties:W},r)}async function ee(e,r,a){return x({layer:e,itemType:p,validateLayer:m,createJSONContext:t=>h(t,e),createItemData:(t,o)=>Promise.resolve(T(t)),errorNamePrefix:$,newItem:r,setItemProperties:Z},a)}export{X as save,ee as saveAs};
